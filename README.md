Hello, my name is Sebastian and this is my final project. I called it 'Profiler' having in mind the idea of making a platform for anyone to make an every-day tracker healthwise. Personally, I've always needed some way of logging everything I eat. From depression to weight problems, what I eat has always affected me noticeably. Basically what I present as my project is a platform where under your profile you search, save and keep track of what you've eaten, and how much. Using the FatSecret API, a mobile app, website and API with nutrition details of thousands of foods or ingredients, and the Canvas JS API to make a dynamic chart to make the representation of the daily nutrition more visually readble than just numbers.

After your first login, using a social authentification or just creating an account, you are asked to enter your macros daily goals, being the total amount of calories, protein, carbohydrates and fat you want or need to consume in a day. Then the main page is the details of the current day you're visiting the app, where you can add and save or just check the nutrition values of everything you ate that day and check how close you are to your daily goals. Theres a calendar where you can click on any day of any year and log the meals you ate under that date. The calendar also has a percentage indicator of how close to your goals you got that day. Then in the account tab you can change your daily goals and your password. In detail (*meal* is used refering to what's saved in the database, being a full dish, a snack or an ingredient; whatever is searched and returned form the API):

### 1 - ``models.py``:
- 1.1 **Breakfast model:** saves any breakfast meal (determined in ``views.py``, see 3.13) including: user that saved the meal (with a ForeignKey linked to the Django User model), date of when the meal was saved in the database, main name of the meal, measure searched for used to scale the nutrients amount, the same measure in metric standards to keep a base measure for everything, quantity of the measure searched for, and the main nutrients given from the API: calories, total carbs, total fat, protein, cholesterol, saturated fat, polyunsaturated fat, monounsaturated fat, fiber, sugars, sodium and potassium.
- 1.2 **Lunch model:** same as Breakfast (see 1.1) but for meals saved as lunch (determined in ``views.py``, see 3.13).
- 1.3 **Dinner model:** same as Breakfast (see 1.1) but for meals saved as dinner (determined in ``views.py``, see 3.13).
- 1.4 **Snack model:** same as Breakfast (see 1.1) but for meals saved as a snack (determined in ``views.py``, see 3.13).
- 1.5 **Calendar model:** keeps the total amount in nutrients for a determined day, having the sum of every meal saved under the same day and user. This is used for the info displayed in the chart (see 3.15) and the detail under the date. Has the a field for the user, the date and every nutrient.
- 1.6 **Goal model:** keeps track of the user's daily nutrient goals, being calories, carbs, protein and fat. This info is contrasted with the info from Calendar model, under the same user, to give the daily percentages in the chart (see 4.9 section 7). The user first saves a daily amount right after the first log in (see 3.16) and can later be changed in the account tab (see 3.17).

### 2 - ``urls.py``:
Firstly, the ``urls.py`` file in the main app folder (called Capstone) has an added path for the Python Social Auth as pointed in the docs ([Python Social Auth docs](https://python-social-auth.readthedocs.io/en/latest/configuration/django.html)).
- 2.1 __*blank*:__ the first, default path, is for the daily details. After logging in the default path will load the details of the current day the user is visiting the site. (see 7)
- 2.2 **/calendar:** for the calendar tab. Loads the calendar starting in the same month and year of the current date, marking the current day (see 4.7 for the Javascript function and 3.7 for the views main function).
- 2.3 **/calendar_details:** loads the users info from the calendar model, quering for the user logged in and the month and year of the current date. This is displayed in the calendar as a percentage of the nutrients consumed contrasted with the total nutrients goal set and the top-right corner of each day box (see 4.7 for the Javascript function and 3.8 for the views function).
- 2.4 __/day/*date*:__ path that loads the daily details of any other day than the current date when the user is visiting the web site. Each day box in the calendar tab triggers this path for the day clicked, passing the date in iso format (see 4.9 for all the Javacript functions running and 3.9 for the views main function).
- 2.5 __/foods_search/*food name*/*page number*:__ path that passes the name of the meal searched to request the information to the API. The API responds with every result matching the word sent paginated, which is made to be 10 results per page as default. The default path will be with page number equal to 1, to show the first matching results given by the API first. Any other page number is requested by the pagination numbers below the first results (see 4.9 section 2 for the Javascript function and 3.11 for the views function).
- 2.6 __/food_get/*ID*:__ path to request the API a particular ID given by the results from quering a meal name (see 2.5). The information of the response may contain more than one result, depending of how many measurements the API has saved under that particular ID. Each measurement result contains the nutrients and measurements information based under said measurement (e.g.: the first result for coffee has result for 1 cup of coffee, 100ml of coffee, 1 mug of coffee, etc.) (see 4.9 section 3 for the Javascript function and 3.12 for the views function).
- 2.7 **/save_meal:** path to save any meal, given in json format (see 4.9 section 6 for the Javascript function and 3.13 for the views function).
- 2.8 __/get_calendar/*date*:__ path to request the Calendar model and Goal model information of one user and a particular date for the Calendar model (Goal model doesn't use a date field). This is used to render the chart (see 4.9 section 7 for the Javascript function and 3.15 for the views function).
- 2.9 **/account:** path to render the account Goals with a request method of 'get' and to save any goal changes made in the account tab with a request method of 'post' (see 4.2 for the Javascript functions and 3.17 for the views function).
- 2.10 **/food_list_:** path to request meals from the Breakfast, Lunch, Dinner and Snack models with a certain date and user. This information is then shown in the food list at the bottom of the day details tab (see 4.9 section 8 for the Javascript function and 3.18 for the views function).
- 2.11 **/login:** path to log in an user (see 3.3).
- 2.12 **/logout:** path to log out any logged in user (see 3.4).
- 2.13 **/register:** path to register any new user with an username, email and password (see 3.5).
- 2.14 **/set_goal:** path to set new nutrition goals for a new user. This path is triggered after any log in of an user (see 3.16).
- 2.15 **/password_change:** path to change the users password in the account tab (see 4.2 section 2 for the Javascript function and 3.6 for the views function).

### 3 - ``views.py``:
Many functions have the '@login_required' decorator, which, if that function is triggered and there is no user logged in, the request gets redirected to the login path.
- 3.1 **lineno():** function that uses the inspect library to give in a print command the code line where this print was written. I used this just as a helper to show where the information printed was from when running trials.
- 3.2 **get_token():** this function requests a authentication token to the FatSecret API to give in any further requests for nutrition details, given a client ID and a client Secret which are found in the FatSecret developer dashboard (see ``requirements.txt`` to run the program). It's part of the API requisites.
- 3.3 **login_view():** authenticates the user loging in with the Django auth library.
- 3.4 **logout_view():** logs out the user using the Django auth library.
- 3.5 **register():** creates a new user given an username, email, password and a password confirmation. This function first checks that the password and confirmation match. Then attempts creating a new user giving an error message if it couldn't, for instance, if the username already exists. After a succesful attempt, the user is redirected to the '/set_goal' path (see 7).
- 3.6 **change_pass():** in the account tab, the 'Change your Password' form sends a 'post' request which is first authenticated using the 'old password' and the user's username and then the user's model is updated with the new password without logging out the user.
- 3.7 **calendar():** function that renders the calendar template, which is then made using javascript (see 4.7).
- 3.8 **calendar_details():** this function fetches the users information form the Calendar model to display, in the calendar tab, a percentage of the daily amount of nutrients the user registered as consumed versus the daily goal, being 100% the user has consumed all the nutrients they set for a daily goal. When the calendar path is triggered, a blank template is filled with Javascript to render the calendar (see 4.7). A request is made to this function with the year and month currently shown in the calendar, being the year and month of the current day the default values and changed everytime the user presses the next or previous month buttons. A blank dictionary is filled with every day of the said month using a for loop form the day 1 to the last day of that month (``monthrange()`` from the python calendar library is used to set how many days does the month have), and each day tries a fetch to the Calendar model which, if succesful (the day has at least one meal registered), the information is adjusted compared to the user's Goal model to respond the request with a percentage number of 'how much nutrients the user has consumed said day compared to their daily goal'. This function has a max of 100%, even if the user exceeded the daily goals. 
- 3.9 **day(date):** this function gets triggered when the user in the calendar tab clicks on a day other than the date marked as 'today'. Each request goes with the date clicked in iso format which is then used to request, or create if the user is new, the Calendar model (see 1.5) information to be displayed beneath the Date Title as an easy way of checking the daily nutritional values.
- 3.10 **today():** same as the previous function ``day()`` (see 3.9) but for the current day. It's the default path after a successful log in.
- 3.11 **fatSecretSearch(food_name, page_num):** this function sends a request to the Fat Secret API with a word or phrase, which the user typed to search for in the day details tab, and a page number. The response gives all the results that match the word given, paginated. The first search, after clicking to add a new breakfast, lunch, dinner or snack, requests the first page, and any other page gets requested by the pagination numbers below the results list.
- 3.12 **fatSecretGet(id):** this function goes after the user clicks on any of the results given by the previous function (``fatSecretSearch()``). A request is made to the Fat Secret API with the 'ID' of the result clicked. The ID is part of the response given by the API in the previous function; each match has a distinct 'ID'. The response is divided in all the measurements the API has recorded for said meal, and each has it's own scaled nutrition details. A meal may have only one measurement available or many; if the latter, they are all displayed in a list at the side of the nutrition table, and if clicked, the nutrition table is changed to show the nutrition values scaled to the measurement clicked. The default measure is the first measure given by the response from the API. All non-metric measurement's nutrition values are determined by the API, for example, how much coffee is a 'serving of coffee' is defined by the API.
- 3.13 **saveNewMeal():** after the user has searched his meals and clicks on the 'save' button, a request is sent to this function with a json which contains the information of every meal in the 'meal list' (list right of the nutrition panel) prior to clicking the save button. A json is made and gets filled as the user searches and adds meals to the list. The API may not have every value of the nutrients, so some foods have undefined as a value. In this function every undefined is turned to value 0 before a model corresponding to a breakfast, lunch, dinner or snack is made for every meal in the json. A call to the function ``updateCalendar(meal, user)`` (see 3.14) is made and then the updated Calendar model of the corresponding day and user is returned as json.
- 3.14 **updateCalendar(meal, user):** is a function called inside the previous ``saveNewMeal()`` function (see 3.13). It updates the previously created Calendar model under certain user and date (see 3.9) and adds the nutrition values just saved to the total.
- 3.15 **getCalendar(date):** this function is called to render the chart in the day details tab. Given the date, it returns the Calendar model of said date and user, and the Goal model of said user.
- 3.16 **set_goal():** this function is called after every log in (see 7). Under a request method of 'get' this function checks if a Goal model already exists for said user. If not, the 'set_goal' template is rendered; otherwise, the user is redirected to the 'today' path (see 2.1). Under a request method of 'post', a Goal model is created under said user and date, with the data from the form given in the 'set_goal' template.
- 3.17 **account():** under a request method of 'get' the template 'account' is rendered, with the information of the Goal model for said user. Under a request method of 'post' a change in the Goal model of said user is made, with the information given as json from the form 'Change Goals' in the 'account' template. A json response containing the new Goal model is given, to display the new goals.
- 3.18 **food_list():** this function is called to display the list of meals in the day details tab and after every click for another page, if any, at the bottom of said list. A request is made containing the date, the type of meal (breakfast, lunch, etc.) and the page number. First, the appropiate model is requested with the user logged in and the date given; if the meal type is 'all', a request is made to the Breakfast, Lunch, Dinner and Snack model and then chained together in a list. Then, using the Paginator library, a list of maximum 5 meals is made and returned as json with the number of total pages to render the appropiate number of page buttons.

### 4 - static\profiler:
- 4.1 **account.css:** styling of the 'account' template (see 5.1).
- 4.2 **account.js:** has two functions for when each 'Change Goals' and 'Change Password' forms are submitted.
    1. **changeGoal():** retrieves the values from the 'Change Goals' form, makes a value check, and adds them to a json which is given in the post request to the ``/account`` path (see 2.9) to be changed. Then displays the new goals in the form after a succesful response.
    2. **changePass():** retrieves the values from the 'Change Password' form, makes a password validation with the new password and the confirmation, and adds them to a json which is sent in the post request to the ``/password_change`` path (see 2.15). Then, after a succesful response an alert is made and the form cleared.
- 4.3 **apple-favicon.ico:** apple icon.
- 4.4 **apple-icon.png:** logo with an apple and the 'Profiler' words. This is rendered in desktop screen sizes.
- 4.5 **apple-mobile.png:** logo of an apple. This is rendered in mobile screen sizes.
- 4.6 **calendar_style.css:** styling of the 'calendar' template (see 5.2).
- 4.7 **calendar.js:** this makes the calendar in the calendar tab. First, a date object is made with the current date of the user logged in. The ``renderCalendar()`` function calculates the number of days the month of the current day has, the number of days of the previous month, the index of the first day of the month of the current date, being 0 for Sunday; the index of the last day of the current month and the amount of days to complete the last week of the month displayed. Then a list is made with all the months in a year, and the date titles are created. A call to the ``/calendar_details`` path is made (see 2.3) and lastly a div is made for every day: for the total of days of the previous month to complete the first week, for every day of the current month and for every day of the next month to complete the last week. Only the days of the current month have the data from the request response shown, which is the percentage of nutrition completed, and a clickable event to redirect to the clicked date. An event listener to the clickable arrows is made for each, adjusting the date object to the next or previous month and running the ``renderCalendar()`` function again.
- 4.8 **day.css:** styling of the 'day' template (see 5.3).
- 4.9 **day.js:** this manages the 'day' template:
    1. **addMealStart():** triggered after the user clicks on any button to add a new meal. Displays the food search box and the corresponding meal list to the right.
    2. **fatSecret(page_num):** triggered after the user clicks to search any food typed in, or if any page number button is clicked at the bottom of the result page. Makes a post request to the ``/foods_search`` path (see 2.5) with the words the user typed in and the page number of the results given by the API. The button next to the input box has a default page number of 1 to give the first results the API gives, given a new word by the user. Then, the results are displayed in a table paginated by 10 results and the new meal list is displayed at the right. Each result has a clickable event to display the nutrition details of that specific food (see 4.9 section 3) giving the ID, the name of the food, the page number where the clicked result is and the serving index, in this case 0 to show the first serving listed in the results of said food.
    3. **foodSearch(food_id, food_name, page_num, serving):** this function gets triggered by the click event on every result in the foods result list (see 4.9 section 2). Sends a post request to the ``/food_get`` path (see 2.6) giving the food ID. First the heading of the nutrition panel is made using the name of the food clicked with, if any, a brand name. Lastly a call to ``makeNutritionPanel(json, serving, page_num)`` is made (see 4.9 section 4) giving the results from the fetchas json, the serving index and the page number.
    4. **makeNutritionPanel(json, serving, page_num):** this function creates the nutrition panel and the list of available servings for certain food. First takes the information from the json and displays it in the nutrition panel and creates an empty list for the different servings a food may have (depends on the information given by the FatSecret API if any food has nutrition scaled to different servings). Then the servings list is filled with the different servings with a clickable event to display the nutrition info scaled to said serving, which is triggering ``foodSearch(food_id, food_name, page_num, serving)`` function (see 4.9 section 3) where only the serving index is changed to be the index of the serving clicked. At the end of the servings list an 'add' button is added with an input field for an amount number. If the user chooses to save the shown food and serving, they can type the amount number of said food and serving, and click on the add button. This will trigger the ``addNewFood(json, serving, quantity)`` (see 4.9 section 5) giving the json of the results from the FatSecret API, the serving index and the quantity the user typed in.
    5. **addNewFood(json, serving, quantity):** this function is triggered after the user clicks on the add button in the servings list of the nutrition panel. The meal gets added to the meal list at the right of the servings list showing the food name, the brand (if any), the quantity and the serving description followed by the calories, carbs, fat and protein scaled to the quantity. A 'save' button is added at the end of the list which has a click event that triggers the ``saveMeal()`` function (see 4.9 section 6). All the nutritional information, the serving description, the quantity and the food name are added to a list, which keeps track of all the foods in the new meal list, to later be saved in the back-end database (this list is a global variable, which is why nothing is passed to the ``saveMeal()`` function as parameters).
    6. **saveMeal():** this function sends a post request to the ``/save_meal`` path (see 2.7) with the list of all the meals in the 'new meal list' that where added in the ``addNewFood(json, serving, quantity)`` function (see 4.9 section 5) as json in the request's body. The fetch gets a response with the Calendar model updated of the date shown and the user logged in, which is used to update the calories, protein, fat and carbs values beneath the date title. Then the meal list is cleared, the 'new meal list' is removed along with the nutrition panel and the food results section. A call is made to the ``renderChart()`` function (see 4.9 section 7) to update the already rendered chart, to show the new nutritional values just added to the database. The Also the calories, protein, fat and carbs values beneath the date title are updated. A call is made to the ``openTab(meal, page_num, elmnt)`` function (see 4.9 section 8) to update the results shown at the bottom of the page in the foods list.
    7. **renderChart():** this function renders the chart at the bottom of the day details tab. First, sends a request to the ``/get_calendar`` path (see 2.8) with the date of the day thats is shown. A json response with Calendar model of said day and user, and Goal model of said user, is returned. This is used to set the chart parameters. First, for each macronutrient, the amount left to complete the daily goal is calculated, along with that number as a percentage. Then using the Canvas JS API the chart is configured changing the parameters as given by the API documents (see [Canvas JS docs](https://canvasjs.com/docs/charts/basics-of-creating-html5-chart/)).
    8. **openTab():** this function renders the foods list at the bottom of the day details tab and is triggered when the page loads and whenever a tab is clicked. First, a post request is made to the ``/food_list`` path (see 2.10) giving the date, the meal type (breakfast, lunch, etc.) and a page number. A json response with the results of the page number given and the total number of pages of the results paginated. The results, if any, are displayed as a list showing the food name, the quantity and the serving measure, followed by the calories, fat, carbs and protein values. After the results a page number set of buttons is added to navigate through the paginated results. If no results are returned, a messagge saying so is displayed.
- 4.10 **goals.css:** styling of the 'set_goal' template (see 5.7).
- 4.11 **google_login_btn.png:** Google logo for the google log in authentication.
- 4.12 **layout.css:** styling for the base layout, specifically the sidebar. Used in account, calendar and day templates.
- 4.13 **login.css:** styling of the 'login' and 'register' templates (see 5.5 and 5.6). 

### 5 - templates\profiler:
- 5.1 **account.html:** html template for the account tab. First edits the sidebar to show the account tab is the one being displayed. Then it has two forms, one for the user to change their nutrition goals which shows the initual values from their model when rendering, and the updated values when the user changes them; and another form for the user to change the password (see 2.9).
- 5.2 **calendar.html:** html template for the calendar tab. First edits the sidebar to show the calendar tab is the one being displayed. Then it has a basic div to hold the calendar which is then filled with javascript (see 4.7).
- 5.3 **day.html:** html template for the day details tab. First edits the sidebar with a condition on wether the current date or other day is being shown. If the current day is shown (first path after every login except the first) the sidebar will note that 'today' is being displayed. If other that the current date is being shown, the sidebar will show the date that is displayed plus a today tab button to switch easily to the current date. Then it has the basic display of the day details tab: the date title, the macronutrient values, the 'add new meal' buttons, a container for the FatSecret API search box (see 4.9), a container for the chart and another for the meals list.
- 5.4 **layout.html:** html layout template which has the DOM distribution and the sidebar.
- 5.5 **login.html:** html template for the log in path. Has a 'messages' (Django messages library) container and conditional to display log in errors, and a form for the user to log in using their username and password or a button to login using Google Auth (Python Social Auth, see ``requirements.txt``, and 2.11 for the login path). 
- 5.6 **register.html:** html template for the register path. Has a simple form for the user to register a new user using an username, email, password and password confimation. Also has a button to go back to log in (see 2.13).
- 5.7 **set_goal.html:**  html template for the user to set their first nutritional goals. Has a basic form for the user to type in their total amount of each macronutrient to consume in a day, guided by the unit measure (see 2.14).

### 6 - ``admin.py``:
The Breakfast, Lunch, Dinner, Snack, Calendar and Goal models are registered for manipulation and user in the admin page.

### 7 - ``settings.py``:
For the Python Social Auth, some changes were made. Firstly, as pointed in the Python Social Auth configuration docs ([Python Social Auth config docs](https://python-social-auth.readthedocs.io/en/latest/configuration/django.html)) a series of changes were made: 
- in INSTALLED_APPS, 'social_django' was added.
- AUTHENTICATION_BACKENDS was added with fields for the Google OAuth2 and a Django model auth field.
- SOCIAL_AUTH_GOOGLE_OAUTH2_KEY and SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET matched with a key and a secret provided by the Google Auth API ([Google Auth docs](https://developers.google.com/identity/protocols/oauth2)). Disclaimer: The secret and key I didn't delete nor did I detailed the process to get a new key in the requirements to run the app, as the ones in the settings file are linked to my google account, because the goal of this project was to learn and to meet the requirements for the course, so I don't expect any high volume of requests to the Google API under my key, and if this key were to be shared or used wrongly or against the Google Auth API usage policy I can delete the credential from the Google Auth dashboard to deny any usage with malicious intent. 
- SOCIAL_AUTH_LOGIN_REDIRECT_URL = '/set_goal' path was added to make sure after every login using the social auth, the user would get redirected to said path (see 2.14).
- SOCIAL_AUTH_ADMIN_USER_SEARCH_FIELDS = ['username', 'first_name', 'email'] was added as pointed in the configuration docs.
- SOCIAL_AUTH_GOOGLE_OAUTH2_AUTH_EXTRA_ARGUMENTS was added with 'access_type': 'offline' as pointed by the docs.
Besides the social auth changes:
- STATIC_URL = '/static/' was added to load the static files.
- LOGIN_REDIRECT_URL = 'set_goal' was added to make sure the user got redirected to this path after a succesful login (see 2.14).


Using the django web framework I made a model for the users, breakfasts, lunches, dinners, snacks and goals. Every model linked to a user with a foreign key, except the goals that has a OneToOne field. With the users I used basic log in authentification and added a Google account auth with the possibility of adding any social account log in. Learning to work with the API used to show the nutrition details was a struggle but I'm glad I managed in the end. This was maybe the third API I tried before settling with it, it had the request variables I was looking for. I used the 'requests' library to make dynamic calls: name of food searched or ingredient, measure looked for, quantity, etc. I tried to make the display of my project be as 'asynchronous' (pardon my french, not sure if its the right word) as I could, using a lot of javascript fetch's to the back end and displaying the info without refreshing the page. This goes for searching and saving any meal/food, as well as the chart displayed. The calendar tab is also dynamic and doesn't need any refreshes to change months or years. 

This project took me longer than I expected, between figuring out how to do things and, well, life. I tried to implement everything I learned that I could use, but I also found other ways or new ways just investigating and searching how to make the ideas I had. I'm pretty satisfied with what I made overall, but I see many ways of improvement. First, I'm not the best UI designer. From what colors to use, what shades go well, where to put things, what fonts are better for the 'image' of the project or better suited to the targeted users; to how to name it: the first thing that comes to mind with the word 'Profiler' is some FBI TV series where they use it refering to how to clasify psycopaths. Secondly, an input checker for every input box would save a lot of user experience incomodities; before throwing any errors, alert the user the input is not correct. My Profiler is not ugly (it started way worse), but it could be much better. Some UI and UX I'm eager to learn very soon. 